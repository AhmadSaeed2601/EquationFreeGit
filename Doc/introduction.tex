%Initially by AJR, Apr 2017 -- Nov 2018
%!TEX root = eqnFreeDevMan.tex
\section{Introduction}
\begin{funDescription}
This document is intended to be used in conjunction with the user manual. It contains line-by-line descriptions of the code in each function in the toolbox. For brief descriptions of each function, quick start guides, and many examples, see the user manual.
\end{funDescription}

\begin{userExample}
\localtableofcontents

\paragraph{Users}
Place this toolbox's folder in a path searched by \script.
Then read the subsection that documents the function of interest.


\paragraph{Blackbox scenario}
Assume that a researcher\slash practitioner has a detailed and \emph{trustworthy} computational simulation of some problem of interest.
The simulation may be written in terms of micro-positional coordinates~\(\xv_i(t)\) in `space' at which there are micro-field variable values~\(\uv_i(t)\) for indices~\(i\) in some (large) set of integers and for time~\(t\).
In lattice problems the positions~\(\xv_i\) would be fixed in time (unless employing a moving mesh on the microscale); in particle problems the positions would evolve.
The positional coordinates are \(\xv_i\in\RR^{d}\) where for spatial problems integer \(d=1,2,3\), but it may be more when solving for a distribution of velocities, or pore sizes, or trader's beliefs, etc.
The micro-field variables could be in~\(\RR^{p}\) for any \(p=1,2,\ldots,\infty\).

Further, assume that the computational simulation is too expensive over all the desired spatial domain~\(\XX\subset\RR^{d}\).
Thus we aim a toolbox to simulate only on macroscale distributed patches.



\paragraph{Contributors}
The aim of this project is to collectively develop a \script\ toolbox of equation-free algorithms.
Initially the algorithms will be simple, and the plan is to subsequently develop more and more capability.

\textsc{Matlab} appears the obvious choice for a first version since it is widespread, reasonably efficient, supports various parallel modes, and development costs are reasonably low.
Further it is built on \textsc{blas} and \textsc{lapack} so potentially the cache and superscalar \cpu{} are well utilised.
Let's develop functions that work for both \script.
\cref{sec:contribute} outlines some details for contributors.


\section{Quick start}
\localtableofcontents
This section may be used in conjunction with the many examples in later sections to help apply the toolbox functions to a particular problem, or to assist in distinguishing between the various functions.

\subsection{Cheat sheet: Projective Integration}
This section pertains to the Projective Integration (PI) methods of Section~\ref{sec:ProjInt}. The PI approach is to greatly accelerate computations of a system exhibiting multiple time scales.

The PI toolbox presents several `main' functions that could separately be called to perform PI, as well as several optional wrapper functions that may be called. This section helps to distinguish between the top-level PI functions, and helps to tell which of the optional functions may be needed at a glance. For full details on each function refer to Section~\ref{sec:ProjInt}.

The cheat sheet consists of two flow charts. For an overview of constructing a PI simulation, see Figure~\ref{fig:constructPI}. For a rough guide as to which of the top-level PI functions should be used, refer to Figure~\ref{fig:PIchoosemacro}.


\begin{figure}[h!]
\centering
\resizebox{\textwidth}{!}{ %resize tikz picture to correct width
\begin{tikzpicture}[node distance = 3ex, auto]
\tikzstyle{bigblock} = [rectangle, draw, thick,   text width=20.5cm, text badly centered,
    rounded corners, minimum height=4ex]
\tikzstyle{block} = [rectangle, draw=red!80!black, thick, anchor=west, fill=white,
    text width=9.8cm, text ragged, rounded corners, minimum height=8ex]
 \tikzstyle{smallblock} = [rectangle, draw=red!80!black, thick, anchor=west, fill=white,
    text width=6cm, text ragged, rounded corners, minimum height=8ex]   
 \tikzstyle{tinyblock} = [rectangle, draw=red!80!black, thick, anchor=west, fill=white,
    text width=4.5cm, text ragged, rounded corners, minimum height=8ex]    
     \tikzstyle{smallenclose} = [rectangle, draw=red!80!black, thick, anchor=west, fill=white,
    text width=6.2cm, text ragged, rounded corners, minimum height=8ex]   
     \tikzstyle{refblock} = [rectangle, draw=blue!80!black, thick, anchor=west, fill=blue!5,
    text width=1cm, rounded corners, minimum height=1.05em] 
\tikzstyle{line} = [draw, -latex']
\tikzstyle{lined} = [draw, latex'-latex']
\node [bigblock,draw=red!80!black,fill=red!10] (gaptooth) {\textbf{Schematic for Projective Integration scheme}\\
    \begin{tikzpicture}[node distance = 3ex, auto]
    \node [block] (setmicro) {\textbf{Set microsolver}\\ 
    Define or construct the function \texttt{solver()} that calls a black box microsolver. Set \texttt{bT}, the time to run microsolver for. Possible aids:\\
    Use the 
    \hyperref[fig:constructpatch]{\begin{tikzpicture}[node distance = 0.5cm, auto]   
    \node [refblock] (ref) {Patch};
    \end{tikzpicture}}
    toolbox to discretise a pde.\\
    Use \texttt{bbgen()} if the microsolver is a standard solver, \texttt{ode45} e.g., and needs to be converted into a black box.\\
    Use \texttt{cmdc()} as a wrapper for the microsolver if the slow variables would otherwise change significantly over the microsolver.};
    \node[block, right=0.2cm of setmicro] (setmacro){\textbf{Set macrosolver, define problem}\\ 
    \vspace{1pt}
        \begin{tikzpicture}
    \node [tinyblock]%, below=0.6cm of pig]
     (pirk) {\textbf{If using \texttt{PIRK()}:}\\ 
    Set the vector of output times \texttt{tspan}. Intervals between times are the time steps in the numerical scheme. Set initial conditions \texttt{IC}.};
   \node [tinyblock, right=0.2cm of pirk]%, below right=0.2cm and -1cm of lift]
    (pig) {\textbf{If using \texttt{PIG()}:}\\ 
    Set the solver \texttt{macro.solver} to be used on the macro scale. Set any needed time inputs or time step data in \texttt{macro.tspan}. Set initial conditions \texttt{IC}.};
    \end{tikzpicture}
    };
   
       \node [tinyblock, below=0.3cm of setmacro] (lift) {\textbf{Set lifting/restriction}\\ 
    If needed, set functions \texttt{restrict()} and \texttt{lift()} to convert between macro and micro problems/variables. These are optional arguments to the \texttt{PI} functions.};
    
 \node [block, below right=0.8cm and -8cm of setmicro] (dopi) {\textbf{Do PI}\\ 
    Call the appropriate PI function as e.g. \\
    \texttt{[t,x] = PIRK2(solver,bT,tspan,IC)}, or\\
    \texttt{[t,x] = PIG(solver,bT,macro,IC)}. \\
    Additional outputs may be requested to obtain details on the micro states and estimates of the slow vector field over the simulation.};
             \path [line, thick] (setmicro) to[out=-90,in=120] (dopi);
         \path [line, thick] (lift) to[out=180,in=3] (dopi);
         \path [line, thick] (setmacro) to[out=-150,in=30] (dopi);
%          \path [line, thick] (pig) to[out=180,in=0] (dopi);
%          \path [line, thick] (pirk) to[out=180,in=0] (dopi);
%          \draw [dashed, very thick] (pig) -- (pirk);
    \end{tikzpicture}
    };   
\end{tikzpicture}
}
\caption{}
\label{fig:constructPI}
\end{figure}

\begin{figure}[h!]
\centering
\resizebox{0.6\textwidth}{!}{ %resize tikz picture to correct width
\begin{tikzpicture}[node distance = 0.5cm, auto]
\tikzstyle{bigblock} = [rectangle, draw, thick,   text badly centered, 
    text width=12cm, rounded corners, minimum height=2em]
\tikzstyle{block} = [rectangle, draw=red!80!black, thick, anchor=west, fill=white,
    text width=5cm, rounded corners, minimum height=4em]
 \tikzstyle{smallblock} = [rectangle, draw=red!80!black, thick, anchor=west, fill=white,
    text width=3.4cm, rounded corners, minimum height=4em]  
 \tikzstyle{yesblock} = [rectangle, draw=red!80!black, thick, anchor=west, fill=white,
    text width=1.2cm, rounded corners, minimum height=1.2em]   
\tikzstyle{line} = [draw, -latex']
\tikzstyle{lined} = [draw, latex'-latex']
\node [bigblock,draw=red!80!black,fill=red!10] (gaptooth) {\textbf{Choosing the macro solver in PI:}\\
\vspace{2pt}
    \begin{tikzpicture}[node distance = 1cm, auto]
    \node [block,right=5cm] (timestep) {\textbf{Is an appropriate time step known for the slow dynamics?}};
    \node [yesblock, below =0.5cm of timestep] (timeyes) {Yes};
    \node [yesblock, right=0.4cm of timestep] (timeno) {No};
    \node [block, below=0.5cm of timeyes] (slowsol) {\textbf{Is a particular solver desired to simulate the slow dynamics?}};
     \node [smallblock, below right=0.5cm and 0.5cm of timeno] (pig) {Choose \texttt{PIG()} to do simulation};
         \node [yesblock, below =0.4cm of slowsol] (slowno) {No};
    \node [yesblock,  right=0.4cm of slowsol] (slowyes) {Yes};
         \node [smallblock, below =0.5cm of slowno] (pirk) {Choose \texttt{PIRK2()} or \texttt{PIRK4()} to do simulation};
         \path [line, thick] (timestep) to[out=-90,in=90] (timeyes);
         \path [line, thick] (timestep) to[out=0,in=180] (timeno);
          \path [line, thick] (timeno) to[out=0,in=90] (pig);
          \path [line, thick] (timeyes) to[out=-90,in=90] (slowsol);
          \path [line, thick] (slowsol) to[out=0,in=180] (slowyes);
          \path [line, thick] (slowsol) to[out=-90,in=90] (slowno);
          \path [line, thick] (slowno) to[out=-90,in=90] (pirk);
          \path [line, thick] (slowyes) to[out=0,in=-90] (pig);
    \end{tikzpicture}
    };   
\end{tikzpicture}
}
\caption{}
\label{fig:PIchoosemacro}
\end{figure}



\subsection{Cheat sheet: constructing patches}
This section pertains to the Patch approach to discretising \textsc{pde}s of Section~\ref{sec:ProjInt}. 

The Patch toolbox requires that one configure patches, couple the patches and interface the coupled patches with a time integrator. For an overview of the chief functions involved and their interactions, see Figure~\ref{fig:constructpatch}.

\begin{figure}[h!]
\centering
\resizebox{\textwidth}{!}{ %resize tikz picture to correct width
\begin{tikzpicture}[node distance = 3ex, auto]
\tikzstyle{bigblock} = [rectangle, draw, thick,   text width=20.5cm, text badly centered,
    rounded corners, minimum height=4ex]
\tikzstyle{block} = [rectangle, draw=blue!80!black, thick, anchor=west, fill=white,
    text width=10cm, text ragged, rounded corners, minimum height=8ex]
 \tikzstyle{smallblock} = [rectangle, draw=blue!80!black, thick, anchor=west, fill=white,
    text width=6cm, text ragged, rounded corners, minimum height=8ex]   
 \tikzstyle{tinyblock} = [rectangle, draw=blue!80!black, thick, anchor=west, fill=white,
    text width=4.5cm, text ragged, rounded corners, minimum height=8ex]      
\tikzstyle{line} = [draw, -latex']
\tikzstyle{lined} = [draw, latex'-latex']
\node [bigblock,draw=blue!80!black,fill=blue!10] (gaptooth) {\textbf{Patch scheme for \textsc{pde}s}\\
\vspace{1pt}
    \begin{tikzpicture}[node distance = 3ex, auto]
    \node [block] (configPatches) {\textbf{Define problem and construct patches}\\ Call \texttt{configpatches1} (for 1D) or \texttt{configpatches2} (for 2D) with inputs which define the microscale problem (\textsc{pde}, domain, boundary conditions etc) and the desired patch structure (number of patches, patch size, coupling order etc).\\
    Output of \texttt{configpatches1} or \texttt{configpatches2}  is the global struct \texttt{patches}. The components of this struct should contain all information required to solve the microscale problem within each patch (function, microscale lattice points in each patch etc). If necessary, the user should define additional components for struct \texttt{patches} (e.g., as in \texttt{HomogenisationExample}).};
    \node [block, below=of configPatches] (microPDE) {\textbf{Solve microscale problem within each patch}\\
    Call the \textsc{pde} solver which is to evaluate the microscale problem within each patch. This solver may be a Matlab defined function (such as \texttt{ode15s} or \texttt{ode45}) or a user defined function (such as Runge--Kutta).\\
    Input of the \textsc{pde} solver is the function \texttt{patchSmooth1} (for 1D) or \texttt{patchSmooth2} (for 2D) which  interfaces with the \textsc{pde} solver and the microscale \textsc{pde}. Other inputs are the time span and initial conditions. Output of the \textsc{pde} solver is the solution of the patch \textsc{pde} over the given time span, but only evaluated within the defined patches.};
    \node [smallblock, above right=-2.2cm and 2cm of microPDE] (patchSmooth1) {\textbf{Interface to time integrators}\\
    The \textsc{pde} function (\texttt{patchSmooth1} or \texttt{patchSmooth2}) interfaces with the \textsc{pde} solve, the microscale \textsc{pde} and the patch coupling conditions. Input is the \textsc{pde} field at one time step and output is the field at the next time step.};
    \node [tinyblock, below left=0.5cm and -3cm of patchSmooth1] (coupling) {\textbf{Coupling conditions}\\
    Coupling conditions are evaluated in \texttt{patchEdge1} (for 1D) or \texttt{patchEdge2} (for 2D) with the coupling order defined by global struct component \texttt{patches.ordCC}.};
    \node [tinyblock, below right=0.5cm and -3cm of patchSmooth1] (micropde) {\textbf{Microscale \textsc{pde}}\\ 
    This \textsc{pde} is defined by the global struct \texttt{patches}, for example component \texttt{patches.fun} defines the function (e.g.,  \texttt{BurgersPDE} or \texttt{heteroDiff}) and \texttt{patches.x} defines the domain of the patches};
    \node [block,draw=red!80!black,fill=red!10, below=of microPDE] (pi) {\hyperref[fig:constructPI]{\textbf{\textbf{Projective integration scheme (if needed)}}}\\
    };    
    \path [lined,very thick,-latex] (configPatches) -- (microPDE);
    \path [lined,very thick] (microPDE) to[out=0,in=180] (patchSmooth1);
    \path [lined,very thick] (patchSmooth1) to[out=270,in=90] (coupling);
    \path [lined,very thick] (patchSmooth1) to[out=270,in=90] (micropde);
    \path [lined,very thick,latex-latex] (microPDE) -- (pi);
    \end{tikzpicture}
    };   
\node [bigblock,draw=black,below=of gaptooth] (process) {\textbf{Process results and plot}};
 \path [lined,very thick,-latex] (gaptooth) -- (process);
\end{tikzpicture}
}
\caption{}
\label{fig:constructpatch}
\end{figure}

\end{userExample}




%\section{Overview of major functions and example scripts}
%\label{sec:smf}
%\localtableofcontents
%
%{% excluding the body gives overview of each function/script
%    \renewcommand{\label}[1]{}%
%    \let\section\subsection%
%    \let\subsection\subsubsection%
%    \let\subsubsection\paragraph%
%    \let\paragraph\subparagraph%
%    \fancyvrbStartStop%
%    \excludeversion{body}
%    \input{../ProjInt/projInt}
%    \input{../Patch/patch}
%    \includeversion{body}
%}%end-exclusion


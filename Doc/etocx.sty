%% LaTeX2e file `etocx.sty'
%% generated by the `filecontents' environment
%% from source `etocx' on 2019/03/04.
%%
% This etocx package aims to be a simple front-end for basic
% use of the etoc package.  Best if loaded after other
% packages.  Package Options: onedeep, twodeep, threedeep
% truncate the tocs at fixed relative depth.
% AJR, http://orcid.org/0000-0001-8930-1552
% with help from JFB 2019/03/03
\def\fileversion{0.2a}
\def\filedate{2019/03/04}
\typeout{-- Package `etocx' \fileversion\space <\filedate> --}
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{etocx}[\filedate\space\fileversion]

% process options
% The default is to truncate all tocs at tocdepth. However,
% these options truncate tocs at fixed relative depth.
% Perhaps twodeep is generally best.
\def\Xetocdeep{9} % Default is truncated at tocdepth
\DeclareOption{onedeep}{\def\Xetocdeep{1}}
\DeclareOption{twodeep}{\def\Xetocdeep{2}}
\DeclareOption{threedeep}{\def\Xetocdeep{3}}
\ProcessOptions

% Build upon the etoc package
\typeout{-- `etocx.sty' requires the `etoc' package --}
\usepackage{etoc}

% try to identify article classes
\newif\ifXetocChaps
\XetocChapstrue
\@ifclassloaded{refart}{\XetocChapsfalse}{}
\@ifclassloaded{article}{\XetocChapsfalse}{}
\@ifclassloaded{scrartcl}{\XetocChapsfalse}{}
\@ifclassloaded{extarticle}{\XetocChapsfalse}{}
\ifXetocChaps\def\XetocHead{% chapter class
      \chapter*{Contents}\ifcase\Xetocdeep
      \or\etocsettocdepth{chapter}
      \or\etocsettocdepth{section}
      \else\fi}
   \else\def\XetocHead{% section class
      \section*{Contents}\ifcase\Xetocdeep
      \or\etocsettocdepth{section}
      \or\etocsettocdepth{subsection}
      \else\fi}
   \fi


\newcommand\XEtocheader{% from article.cls
    \@startsection{subsubsection}{3}{\z@}%
    {-3.25ex\@plus -1ex \@minus -.2ex}%
    {1.5ex \@plus .2ex}%
    {\normalfont\normalsize\itshape}}

\etocchecksemptiness% required for following to work
%******************************************************************************
% HACK (JFB, March 2 2019)
% attention this hack may become obsolete in future etoc versions
\let\Etoc@setemptytocboolORIGINAL\Etoc@setemptytocbool
\def\Etoc@setemptytocbool
{% Hack
    \Etoc@setemptytocboolORIGINAL
    \global\let\OUR@ETOC@LOCALTOP\Etoc@localtop
}
\def\OUR@ETOC@LOCALTOP{-\thr@@}
% this next is only needed due to the way the \ifcase are done next
\def\SHIFTED@ETOC@LOCALTOP{\numexpr\OUR@ETOC@LOCALTOP+1\relax}
\def\Etoc@localtop{-\thr@@}% just to be safe
% The \SHIFTED@ETOC@LOCALTOP is used below
%*******************************************************************************
% Set basic format of the various contents
\ifcase\Xetocdeep
\or%
\setcounter{tocdepth}{5}%need to store deep info (JFB no wrong) AJR needs it?
\etocsettocstyle{% one deep
  \ifcase\SHIFTED@ETOC@LOCALTOP\section*{Part contents}\etocsettocdepth{chapter}%
  \or\subsection*{Chapter contents}\etocsettocdepth{section}%
  \or\XEtocheader*{Section contents}\etocsettocdepth{subsection}%
  \or\XEtocheader*{Subsection contents}\etocsettocdepth{subsubsection}%
  \or\XEtocheader*{Subsubsection contents}\etocsettocdepth{paragraph}%
  \or\etocsettocdepth{paragraph}% a bit strange?? AJR Nov 2018
  \or%empty
  \or%empty
  \else\XetocHead%
  \fi
  \par}{\bigskip\noindent}
\or%
\setcounter{tocdepth}{5}%need to store deep info (JFB no wrong) AJR needs it?
\etocsettocstyle{% two deep
  \ifcase\SHIFTED@ETOC@LOCALTOP\section*{Part contents}\etocsettocdepth{section}%
  \or\subsection*{Chapter contents}\etocsettocdepth{subsection}%
  \or\XEtocheader*{Section contents}\etocsettocdepth{subsubsection}%
  \or\XEtocheader*{Subsection contents}\etocsettocdepth{paragraph}%
  \or\XEtocheader*{Subsubsection contents}\etocsettocdepth{subparagraph}%
  \or%empty
  \or%empty
  \else\XetocHead%
  \fi\par}{\bigskip\noindent}
\else%
\etocsettocstyle{% default case
  \ifcase\SHIFTED@ETOC@LOCALTOP\section*{Part contents}%
  \or\subsection*{Chapter contents}%
  \or\XEtocheader*{Section contents}%
  \or\XEtocheader*{Subsection contents}%
  \or\XEtocheader*{Subsubsection contents}%
  \or%empty
  \or%empty
  \else\XetocHead%
  \fi\par}{\bigskip\noindent}
\fi%end-case of how deep


% Use minitoc commands to invoke etocs
\AtBeginDocument{%
\let\secttoc\localtableofcontents
\let\minitoc\localtableofcontents
\let\parttoc\localtableofcontents
\let\doparttoc\relax
\let\dominitoc\relax
\let\dosecttoc\relax
}
